<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV Loader</title>
    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-beta/css/bootstrap.min.css'>
    <link rel='stylesheet' href='https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap4.min.css'>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Microsoft YaHei", "PingFang SC", system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }

        /* Override Bootstrap dark theme */
        .table {
            color: #fff;
        }

        .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .table-striped tbody tr:nth-of-type(even) {
            background-color: rgba(255, 255, 255, 0.02);
        }

        .table-bordered {
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .table-bordered td, .table-bordered th {
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .table thead th {
            background-color: rgba(59, 130, 246, 0.3);
            border-color: rgba(255, 255, 255, 0.2);
            color: #a8d8ea;
        }

        /* DataTables dark theme overrides */
        .dataTables_wrapper {
            color: #fff;
        }

        .dataTables_wrapper .dataTables_length,
        .dataTables_wrapper .dataTables_filter,
        .dataTables_wrapper .dataTables_info,
        .dataTables_wrapper .dataTables_paginate {
            color: #a8d8ea;
        }

        .dataTables_wrapper .dataTables_length select,
        .dataTables_wrapper .dataTables_filter input {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            border-radius: 6px;
            padding: 5px 10px;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button {
            color: #fff !important;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            margin: 0 2px;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
            background: rgba(59, 130, 246, 0.5) !important;
            border-color: #3B82F6 !important;
            color: #fff !important;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            background: #3B82F6 !important;
            border-color: #3B82F6 !important;
            color: #fff !important;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button.disabled {
            opacity: 0.4;
        }

        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #333;
            z-index: 1001;
            background: #1a1a2e;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }

        .sidebar.open {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 15px 10px;
            font-size: 14px;
            font-weight: bold;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #0d0d1a;
            color: #4da6ff;
        }

        .sidebar-header button {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: inherit;
            font-size: 16px;
        }

        .sidebar-access-code {
            padding: 10px;
            border-bottom: 1px solid #333;
        }

        .sidebar-access-code input {
            width: 80px;
            padding: 8px 12px;
            font-size: 14px;
            border: 2px solid #ff9800;
            border-radius: 6px;
            background: #2a2a2a;
            color: #fff;
            outline: none;
        }

        .sidebar-access-code span {
            margin-left: 8px;
            font-size: 12px;
            color: #888;
        }

        .sidebar-new-file-btn {
            margin: 10px;
            padding: 12px 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
        }

        .sidebar-new-file-btn:hover {
            background: #45a049;
        }

        .sidebar-file-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .sidebar-file-item {
            margin-bottom: 8px;
            padding: 10px;
            background: #2c2c3e;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }

        .sidebar-file-item.selected {
            background: #3B82F6;
        }

        .sidebar-file-item:hover {
            background: #3d3d52;
        }

        .sidebar-file-item.selected:hover {
            background: #2563EB;
        }

        .sidebar-file-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 13px;
        }

        .sidebar-file-actions {
            display: flex;
            gap: 4px;
        }

        .sidebar-file-actions button {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .sidebar-edit-btn {
            background: #2196F3;
            color: white;
        }

        .sidebar-delete-btn {
            background: #f44336;
            color: white;
        }

        .sidebar-refresh-btn {
            margin: 10px;
            padding: 10px 16px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
        }

        .sidebar-refresh-btn:hover {
            background: #1976D2;
        }

        .sidebar-no-files {
            padding: 20px;
            color: #888;
        }

        .sidebar-rename-input {
            flex: 1;
            padding: 4px;
            background: #1a1a2e;
            border: 1px solid #444;
            border-radius: 3px;
            color: white;
            font-size: 12px;
        }

        .sidebar-rename-confirm {
            padding: 4px 8px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }

        .sidebar-rename-cancel {
            padding: 4px 8px;
            background: #666;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }

        .sidebar-toggle-btn {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1000;
            padding: 8px 16px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .sidebar-toggle-btn:hover {
            background: #1976D2;
        }

        .sidebar.open ~ .sidebar-toggle-btn {
            left: 290px;
        }

        /* Main content */
        .main-content {
            padding: 20px;
            padding-top: 60px;
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            font-size: 1.8rem;
            margin-bottom: 15px;
            color: #a8d8ea;
            text-align: center;
        }

        .lead {
            color: #888;
            text-align: center;
            margin-bottom: 20px;
        }

        /* File input styling */
        .file-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .file-input-wrapper input[type="file"] {
            background: rgba(255, 255, 255, 0.1);
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 15px 20px;
            color: #fff;
            cursor: pointer;
        }

        .file-input-wrapper input[type="file"]:hover {
            border-color: #3B82F6;
            background: rgba(59, 130, 246, 0.1);
        }

        .save-table-btn {
            padding: 12px 24px;
            background: #10B981;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: none;
        }

        .save-table-btn:hover {
            background: #059669;
        }

        .save-table-btn.visible {
            display: inline-block;
        }

        /* Table container */
        #table-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        #table-container p {
            color: #888;
            text-align: center;
            padding: 40px;
        }

        /* Cell interactions */
        td, th {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        td:hover {
            background-color: rgba(59, 130, 246, 0.3) !important;
        }

        td.copied {
            background-color: rgba(16, 185, 129, 0.4) !important;
        }

        /* Truncate long cell content */
        table.dataTable td {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Toast notification */
        .toast-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #10B981;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .toast-notification.show {
            opacity: 1;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
            }
            .sidebar.open ~ .sidebar-toggle-btn {
                left: 10px;
                top: auto;
                bottom: 10px;
            }
            .main-content {
                padding: 15px;
                padding-top: 60px;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <span>SAVED TABLES</span>
            <button onclick="toggleSidebar()">&#10005;</button>
        </div>
        <div class="sidebar-access-code" id="accessCodeSection" style="display: none;">
            <input type="text" id="accessCodeInput" placeholder="123" autocomplete="off">
            <span>Access code</span>
        </div>
        <button class="sidebar-new-file-btn" onclick="saveCurrentTable()">&#128190; Save Current Table</button>
        <div class="sidebar-file-list" id="fileList">
            <div class="sidebar-no-files">No tables saved yet</div>
        </div>
        <button class="sidebar-refresh-btn" onclick="loadFiles()">Refresh</button>
    </div>

    <!-- Sidebar Toggle Button -->
    <button class="sidebar-toggle-btn" id="sidebarToggle" onclick="toggleSidebar()">&#9776; Tables</button>

    <div class="main-content">
        <h1>CSV Table Loader</h1>
        <p class="lead">Upload a CSV file or load a saved table. Click any cell to copy its content.</p>

        <div class="file-input-wrapper">
            <input type="file" id="csv-file" name="files" accept=".csv" />
            <button class="save-table-btn" id="saveTableBtn" onclick="saveCurrentTable()">&#128190; Save Table</button>
        </div>

        <div id="table-container">
            <p>Upload a CSV file or select a saved table to view</p>
        </div>
    </div>

    <div id="toast" class="toast-notification">Copied!</div>

    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js'></script>
    <script src='https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js'></script>
    <script src='https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap4.min.js'></script>

    <script>
        // ============ SIDEBAR & FILE MANAGEMENT ============
        let files = {};
        let selectedFile = null;
        let editingFileName = null;
        let currentTableData = null; // Store current table data for saving
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('sidebarToggle');
            sidebar.classList.toggle('open');
            if (sidebar.classList.contains('open')) {
                toggleBtn.innerHTML = '&#9664; Hide';
            } else {
                toggleBtn.innerHTML = '&#9776; Tables';
            }
        }

        async function loadFiles() {
            try {
                if (isLocalhost) {
                    const storedFiles = localStorage.getItem('csv-tables');
                    files = storedFiles ? JSON.parse(storedFiles) : {};
                } else {
                    const response = await fetch('/api/files');
                    if (response.ok) {
                        const data = await response.json();
                        files = data.files || {};
                    }
                }
                // Show access code section if not localhost
                if (!isLocalhost) {
                    document.getElementById('accessCodeSection').style.display = 'block';
                }
                renderFileList();
            } catch (err) {
                console.error('Error loading files:', err);
            }
        }

        function renderFileList() {
            const fileListEl = document.getElementById('fileList');
            const filenames = Object.keys(files).sort();

            if (filenames.length === 0) {
                fileListEl.innerHTML = '<div class="sidebar-no-files">No tables saved yet</div>';
                return;
            }

            fileListEl.innerHTML = filenames.map(filename => {
                const isSelected = selectedFile === filename;
                const isEditing = editingFileName === filename;

                if (isEditing) {
                    return `
                        <div class="sidebar-file-item ${isSelected ? 'selected' : ''}">
                            <input type="text" class="sidebar-rename-input" id="renameInput" value="${filename}" onkeypress="if(event.key==='Enter')confirmRename()">
                            <button class="sidebar-rename-confirm" onclick="confirmRename()">&#10003;</button>
                            <button class="sidebar-rename-cancel" onclick="cancelRename()">&#10005;</button>
                        </div>
                    `;
                }

                return `
                    <div class="sidebar-file-item ${isSelected ? 'selected' : ''}" onclick="selectFile('${filename}')">
                        <span class="sidebar-file-name">${filename}</span>
                        <div class="sidebar-file-actions" onclick="event.stopPropagation()">
                            <button class="sidebar-edit-btn" onclick="startRenameFile('${filename}')" title="Rename">&#9998;</button>
                            <button class="sidebar-delete-btn" onclick="deleteFile('${filename}')" title="Delete">&#128465;</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function saveCurrentTable() {
            if (!currentTableData || currentTableData.length === 0) {
                alert('No table data to save! Please load a CSV file first.');
                return;
            }

            const filename = prompt('Enter a name for this table:', selectedFile || 'my-table');
            if (!filename) return;

            let finalName = filename.trim();
            if (!finalName.endsWith('.json')) {
                finalName += '.json';
            }

            saveFile(finalName, JSON.stringify(currentTableData));
        }

        async function saveFile(filename, content) {
            try {
                if (isLocalhost) {
                    files[filename] = content;
                    localStorage.setItem('csv-tables', JSON.stringify(files));
                    selectedFile = filename;
                    showToast('Table saved locally!');
                } else {
                    const accessCode = document.getElementById('accessCodeInput').value.trim();
                    if (accessCode !== '123') {
                        alert('Please enter access code "123" to save');
                        return;
                    }

                    const response = await fetch('/api/files', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            filename: filename,
                            content: content,
                            accessCode: accessCode,
                        }),
                    });

                    if (response.ok) {
                        files[filename] = content;
                        selectedFile = filename;
                        showToast('Table saved!');
                    } else {
                        const data = await response.json();
                        alert('Error saving: ' + (data.error || 'Unknown error'));
                    }
                }
                renderFileList();
            } catch (err) {
                console.error('Error saving file:', err);
                alert('Error saving file');
            }
        }

        function selectFile(filename) {
            selectedFile = filename;
            const content = files[filename];

            try {
                const data = JSON.parse(content);
                currentTableData = data;
                renderTableFromData(data);
                document.getElementById('saveTableBtn').classList.add('visible');
            } catch (e) {
                console.error('Error parsing saved table:', e);
                alert('Error loading saved table');
            }

            renderFileList();
        }

        async function deleteFile(filename) {
            if (!confirm(`Delete "${filename}"?`)) return;

            try {
                if (isLocalhost) {
                    delete files[filename];
                    localStorage.setItem('csv-tables', JSON.stringify(files));
                    if (selectedFile === filename) {
                        selectedFile = null;
                    }
                } else {
                    const accessCode = document.getElementById('accessCodeInput').value.trim();
                    if (accessCode !== '123') {
                        alert('Please enter access code "123" to delete');
                        return;
                    }

                    const response = await fetch(`/api/files?filename=${encodeURIComponent(filename)}`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ accessCode: accessCode }),
                    });

                    if (response.ok) {
                        delete files[filename];
                        if (selectedFile === filename) {
                            selectedFile = null;
                        }
                    } else {
                        alert('Error deleting file');
                        return;
                    }
                }
                renderFileList();
                showToast('Table deleted');
            } catch (err) {
                console.error('Error deleting file:', err);
                alert('Error deleting file');
            }
        }

        function startRenameFile(filename) {
            editingFileName = filename;
            renderFileList();
            setTimeout(() => {
                const input = document.getElementById('renameInput');
                if (input) input.focus();
            }, 0);
        }

        function cancelRename() {
            editingFileName = null;
            renderFileList();
        }

        async function confirmRename() {
            const input = document.getElementById('renameInput');
            let newName = input ? input.value.trim() : '';

            if (!newName || newName === editingFileName) {
                cancelRename();
                return;
            }

            if (!newName.endsWith('.json')) {
                newName += '.json';
            }

            if (files[newName]) {
                alert('A table with this name already exists!');
                return;
            }

            if (!isLocalhost) {
                const accessCode = document.getElementById('accessCodeInput').value.trim();
                if (accessCode !== '123') {
                    alert('Please enter access code "123" to rename');
                    return;
                }
            }

            const content = files[editingFileName];

            if (isLocalhost) {
                delete files[editingFileName];
                files[newName] = content;
                localStorage.setItem('csv-tables', JSON.stringify(files));
                if (selectedFile === editingFileName) {
                    selectedFile = newName;
                }
            } else {
                await saveFile(newName, content);
                await deleteFile(editingFileName);
                selectedFile = newName;
            }

            editingFileName = null;
            renderFileList();
        }

        // ============ TABLE FUNCTIONS ============
        var originalData = {};

        function showToast(message) {
            var toast = document.getElementById('toast');
            toast.textContent = message || 'Copied!';
            toast.classList.add('show');
            setTimeout(function() {
                toast.classList.remove('show');
            }, 1500);
        }

        function copyToClipboard(text, cell) {
            navigator.clipboard.writeText(text).then(function() {
                var preview = text.replace(/[\r\n]+/g, ' ').trim();
                preview = preview.length > 40 ? preview.substring(0, 40) + '...' : preview;
                showToast('Copied: ' + preview);
                $(cell).addClass('copied');
                setTimeout(function() {
                    $(cell).removeClass('copied');
                }, 500);
            }).catch(function(err) {
                console.error('Failed to copy: ', err);
                showToast('Failed to copy');
            });
        }

        function renderTableFromData(data) {
            if (!data || data.length === 0) {
                $('#table-container').html('<p>No data to display</p>');
                return;
            }

            var numCols = data[0] ? data[0].length : 0;

            var columns = [];
            for (var i = 0; i < numCols; i++) {
                (function(colIndex) {
                    columns.push({
                        title: 'Column ' + (colIndex + 1),
                        render: function(cellData, type, row) {
                            var value = row[colIndex];
                            if (type === 'display') {
                                var display = (value !== null && value !== undefined) ? String(value) : '';
                                display = display.replace(/[\r\n]+/g, ' ').trim();
                                return $('<div>').text(display).html();
                            }
                            return value;
                        }
                    });
                })(i);
            }

            originalData = {};
            data.forEach(function(row, rowIndex) {
                originalData[rowIndex] = {};
                for (var colIndex = 0; colIndex < row.length; colIndex++) {
                    originalData[rowIndex][colIndex] = row[colIndex] !== null && row[colIndex] !== undefined ? String(row[colIndex]) : '';
                }
            });

            $('#table-container').html('<table id="csv-table" class="table table-bordered table-striped" style="width:100%"></table>');

            var table = $('#csv-table').DataTable({
                data: data,
                columns: columns,
                pageLength: 25,
                scrollX: true
            });

            $('#csv-table tbody').on('click', 'td', function() {
                var cell = table.cell(this);
                var rowIndex = cell.index().row;
                var colIndex = cell.index().column;
                var originalValue = originalData[rowIndex][colIndex];
                copyToClipboard(originalValue, this);
            });

            $('#csv-table thead').on('click', 'th', function() {
                var text = $(this).text();
                copyToClipboard(text, this);
            });
        }

        function renderTable(papa) {
            currentTableData = papa.data;
            renderTableFromData(papa.data);
            document.getElementById('saveTableBtn').classList.add('visible');
        }

        function handleFileSelect(evt) {
            var file = evt.target.files[0];
            originalData = {};
            selectedFile = null;

            Papa.parse(file, {
                header: false,
                delimiter: ",",
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    console.log(results);
                    renderTable(results);
                    renderFileList();
                }
            });
        }

        // ============ INITIALIZATION ============
        $(document).ready(function() {
            $("#csv-file").change(handleFileSelect);
            loadFiles();
        });
    </script>
</body>
</html>
